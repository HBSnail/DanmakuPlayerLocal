function CommentFilter(){this.modifiers=[],this.runtime=null,this.allowTypes={1:!0,4:!0,5:!0,6:!0,7:!0,8:!0,17:!0},this.doModify=function(t){for(var e=0;e<this.modifiers.length;e++)t=this.modifiers[e](t);return t},this.beforeSend=function(t){return t},this.doValidate=function(t){return!!this.allowTypes[t.mode]},this.addRule=function(t){},this.addModifier=function(t){this.modifiers.push(t)},this.runtimeFilter=function(t){return null==this.runtime?t:this.runtime(t)},this.setRuntimeFilter=function(t){this.runtime=t}}function BilibiliParser(t,e,i){function s(t){return t.replace(/\t/,"\\t")}function n(t){if("["==t.charAt(0))switch(t.charAt(t.length-1)){case"]":return t;case'"':return t+"]";case",":return t.substring(0,t.length-1)+'"]';default:return n(t.substring(0,t.length-1))}if("["!==t.charAt(0))return t}if(null!==t)var o=t.getElementsByTagName("d");else{if(!document||!document.createElement)return[];if(i){if(!confirm("XML Parse Error. \n Allow tag soup parsing?\n[WARNING: This is unsafe.]"))return[]}else e=e.replace(new RegExp("</([^d])","g"),"</disabled $1"),e=e.replace(new RegExp("</(S{2,})","g"),"</disabled $1"),e=e.replace(new RegExp("<([^d/]W*?)","g"),"<disabled $1"),e=e.replace(new RegExp("<([^/ ]{2,}W*?)","g"),"<disabled $1");var r=document.createElement("div");r.innerHTML=e;var o=r.getElementsByTagName("d")}for(var a=[],h=0;h<o.length;h++)if(null!=o[h].getAttribute("p")){var l=o[h].getAttribute("p").split(",");if(!o[h].childNodes[0])continue;var e=o[h].childNodes[0].nodeValue,d={};if(d.stime=Math.round(1e3*parseFloat(l[0])),d.size=parseInt(l[2]),d.color=parseInt(l[3]),d.mode=parseInt(l[1]),d.date=parseInt(l[4]),d.pool=parseInt(l[5]),d.position="absolute",null!=l[7]&&(d.dbid=parseInt(l[7])),d.hash=l[6],d.border=!1,d.mode<7)d.text=e.replace(/(\/n|\\n|\n|\r\n)/g,"\n");else if(7==d.mode)try{if(adv=JSON.parse(s(n(e))),d.shadow=!0,d.x=parseFloat(adv[0]),d.y=parseFloat(adv[1]),(Math.floor(d.x)<d.x||Math.floor(d.y)<d.y)&&(d.position="relative"),d.text=adv[4].replace(/(\/n|\\n|\n|\r\n)/g,"\n"),d.rZ=0,d.rY=0,adv.length>=7&&(d.rZ=parseInt(adv[5],10),d.rY=parseInt(adv[6],10)),d.motion=[],d.movable=!1,adv.length>=11){d.movable=!0;var c=500,p={x:{from:d.x,to:parseFloat(adv[7]),dur:c,delay:0},y:{from:d.y,to:parseFloat(adv[8]),dur:c,delay:0}};if(""!==adv[9]&&(c=parseInt(adv[9],10),p.x.dur=c,p.y.dur=c),""!==adv[10]&&(p.x.delay=parseInt(adv[10],10),p.y.delay=parseInt(adv[10],10)),adv.length>11&&(d.shadow=adv[11],"true"===d.shadow&&(d.shadow=!0),"false"===d.shadow&&(d.shadow=!1),null!=adv[12]&&(d.font=adv[12]),adv.length>14)){"relative"===d.position&&(console.log("Cannot mix relative and absolute positioning"),d.position="absolute");for(var f=adv[14],u={x:p.x.from,y:p.y.from},m=[],g=new RegExp("([a-zA-Z])\\s*(\\d+)[, ](\\d+)","g"),y=f.split(/[a-zA-Z]/).length-1,_=g.exec(f);null!==_;){switch(_[1]){case"M":u.x=parseInt(_[2],10),u.y=parseInt(_[3],10);break;case"L":m.push({x:{from:u.x,to:parseInt(_[2],10),dur:c/y,delay:0},y:{from:u.y,to:parseInt(_[3],10),dur:c/y,delay:0}}),u.x=parseInt(_[2],10),u.y=parseInt(_[3],10)}_=g.exec(f)}p=null,d.motion=m}null!==p&&d.motion.push(p)}d.dur=2500,adv[3]<12&&(d.dur=1e3*adv[3]);var r=adv[2].split("-");if(null!=r&&r.length>1){var v=parseFloat(r[0]),x=parseFloat(r[1]);d.opacity=v,v!==x&&(d.alpha={from:v,to:x})}}catch(t){console.log("[Err] Error occurred in JSON parsing"),console.log("[Dbg] "+e)}else 8==d.mode&&(d.code=e);null!=d.text&&(d.text=d.text.replace(/\u25a0/g,"█")),a.push(d)}return a}window.getjson=function(t,e){var i;i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),i.onreadystatechange=function(){4==i.readyState&&e(200==i.status&&"{"==i.response.substr(0,1)&&"}"==i.response.substr(-1,1)?JSON.parse(i.response):{code:-502,message:"网络错误"})},i.open("GET",t,!0),i.withCredentials=!0,i.send()};var CCLScripting=function(t){this.version=1,this.workerUrl=t,this.logger=new function(){this.log=function(t){console.log(t)},this.error=function(t){console.error(t)},this.warn=function(t){console.warn(t)}},this.getWorker=function(){return new Worker(this.workerUrl)},this.getScriptingContext=function(t){return new this.ScriptingContext(this,t)},this.getSandbox=function(t,e){return new this.BridgedSandbox(this,t,e)}};(function(){if(!CCLScripting)throw new Error("CCL: Scripting engine not defined.");CCLScripting.prototype.ScriptingContext=function(t,e){var i={};this.registerObject=function(s,n){return"function"!=typeof this.Unpack[n.class]?void t.logger.error('Cannot unpack class "'+n.class+'". No valid unpacker found'):void(i[s]=new this.Unpack[n.class](e,n,this))},this.deregisterObject=function(t){delete i[t]},this.updateProperty=function(e,s,n){return i[e]?void 0===i[e][s]?void t.logger.error('Property "'+s+'" not defined for object of type '+i[e].getClass()+"."):void(i[e][s]=n):void t.logger.error("Object ("+e+") not found.")},this.callMethod=function(e,s,n){if(!i[e])return void t.logger.error("Object ("+e+") not found.");if(!i[e][s])return void t.logger.error('Method "'+s+'" not defined for object of type '+i[e].getClass()+".");try{i[e][s](n)}catch(e){e.stack?t.logger.error(e.stack):t.logger.error(e.toString())}},this.getObject=function(e){return i.hasOwnProperty(e)?i[e]:(t.logger.error("Object ("+e+") not found."),i[e])},this.invokeError=function(e,i){switch(i){case"err":t.logger.error(e);break;case"warn":t.logger.warn(e);break;default:case"log":t.logger.log(e)}},this.clear=function(){},this.getDimensions=function(){return{stageWidth:e.offsetWidth,stageHeight:e.offsetHeight,screenWidth:window.screen.width,screenHeight:window.screen.height}}},CCLScripting.prototype.ScriptingContext.prototype.Unpack={},CCLScripting.prototype.BridgedSandbox=function(t,e,i){var s=t.getWorker(),n=t.getScriptingContext(e),o=i,r={},a=!1,h=this;if(!s)throw new Error("SANDBOX: Worker pool exhausted.");this.getLogger=function(){return t.logger},this.getPlayer=function(){return o},this.getContext=function(){return n},this.addListener=function(t,e){return r[t]||(r[t]={max:0,listeners:[]}),!(r[t].max>0&&r[t].listeners.length>=r[t].max)&&(r[t].listeners.push(e),!0)};var l=function(e){if(r[e.channel]&&r[e.channel].listeners)for(var i=0;i<r[e.channel].listeners.length;i++)r[e.channel].listeners[i](e.payload);else t.logger.warn('Message for channel "'+e.channel+'" but channel not existant.')},d=function(e){try{var i=JSON.parse(e.data)}catch(t){return void console.log(t)}if(""!==i.channel)if("::worker"===i.channel.substring(0,8)){var s=i.channel.substring(8);switch(s){case":state":"running"===i.payload&&"worker"===i.auth&&(a=!0,r={},h.init());break;default:console.log(i)}}else l(i);else switch(i.mode){case"log":default:t.logger.log(i.obj);break;case"warn":t.logger.warn(i.obj);break;case"err":t.logger.error(i.obj);break;case"fatal":return t.logger.error(i.obj),void h.resetWorker()}};this.resetWorker=function(){try{s.terminate()}catch(t){}if(s=t.getWorker(),!s)throw new Error("SANDBOX: Worker pool exhausted.");s.addEventListener("message",d)},s.addEventListener("message",d),this.eval=function(t){if(!a)throw new Error("Worker offline");s.postMessage(JSON.stringify({channel:"::eval",payload:t}))},this.send=function(t,e){s.postMessage(JSON.stringify({channel:t,payload:e}))}},CCLScripting.prototype.BridgedSandbox.prototype.init=function(){var t=this;t.send("Update:DimensionUpdate",t.getContext().getDimensions()),this.addListener("Runtime::alert",function(t){alert(t)}),this.addListener("Runtime::clear",function(){t.getContext().clear()}),this.addListener("Player::action",function(e){try{if(null==t.getPlayer())return void t.getLogger().warn("Player not initialized!");switch(e.action){default:return;case"play":t.getPlayer().play();break;case"pause":t.getPlayer().pause();break;case"seek":t.getPlayer().seek(e.params);break;case"jump":t.getPlayer().jump(e.params)}}catch(e){e.stack?t.getLogger().error(e.stack):t.getLogger().error(e.toString())}}),this.addListener("Runtime:RegisterObject",function(e){t.getContext().registerObject(e.id,e.data)}),this.addListener("Runtime:DeregisterObject",function(e){t.getContext().deregisterObject(e.id)}),this.addListener("Runtime:CallMethod",function(e){t.getContext().callMethod(e.id,e.method,e.params)}),this.addListener("Runtime:UpdateProperty",function(e){t.getContext().updateProperty(e.id,e.name,e.value)}),t.getContext().registerObject("__root",{class:"SpriteRoot"})}})(),function(){var t=function(t,e,i,s){var n=null;if("text"===t)return document.createTextNode(e);n="svg"===t?document.createElementNS("http://www.w3.org/2000/svg","svg"):document.createElement(t);for(var o in e)if("style"!==o&&"className"!==o)n.setAttribute(o,e[o]);else if("className"===o)n.className=e[o];else for(var r in e.style)n.style[r]=e.style[r];if(i)for(var a=0;a<i.length;a++)null!=i[a]&&n.appendChild(i[a]);return s&&"function"==typeof s&&s(n),n},e=CCLScripting.prototype.ScriptingContext;e.prototype.Unpack.TextField=function(e,i,s){this.DOM=t("div",{style:{position:"absolute",opacity:null!=i.alpha?i.alpha:1,transformOrigin:"0 0 0"},className:"cmt"}),this.DOM.appendChild(document.createTextNode(i.text));var n=function(t){"string"==typeof t&&(t=parseInt(t),NaN===t&&(t=0));for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e};this.setTextFormat=function(t){this.DOM.style.fontFamily=t.font,this.DOM.style.fontSize=t.size+"px",this.DOM.style.color=n(t.color),t.color<=16&&(this.DOM.style.textShadow="0 0 1px #fff"),t.bold&&(this.DOM.style.fontWeight="bold"),t.underline&&(this.DOM.style.textDecoration="underline"),t.italic&&(this.DOM.style.fontStyle="italic"),this.DOM.style.margin=t.margin},this.setTextFormat(i.textFormat),this.setX=function(t){i.x=t,this.DOM.style.left=i.x+"px"},this.setY=function(t){i.y=t,this.DOM.style.top=i.y+"px"},this.setAlpha=function(t){i.alpha=t,this.DOM.style.opacity=t},this.setX(i.x),this.setY(i.y),this.setText=function(e){this.DOM.innerHTML="",this.DOM.appendChild(t("text",e))},this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(t){return"hidden"!==this.DOM.style.visibility}),this.__defineSetter__("alpha",function(t){this.setAlpha(t)}),this.__defineGetter__("alpha",function(t){return i.alpha}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(t){return i.x}),this.__defineGetter__("y",function(t){return i.y}),this.__defineGetter__("text",function(t){return this.DOM.textContent}),this.__defineSetter__("text",function(t){this.setText(t)}),this.__defineGetter__("filters",function(t){return[]}),this.__defineSetter__("filters",function(t){this.setFilters([t])}),this.__defineGetter__("transform",function(t){return{}}),this.__defineGetter__("transform",function(t){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode)var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]],i="matrix("+e.join(",")+")";else var i="matrix3d("+t.matrix.join(",")+")";this.DOM.style.transform=i}),this.setFilters=function(t){for(var e=[],i=0;i<t[0].length;i++){var s=t[0][i];if("blur"===s.type)e.push([0,0,Math.max(s.params.blurX,s.params.blurY)+"px"].join(" "));else if("glow"===s.type)for(var i=0;i<Math.min(2,s.params.strength);i++)e.push([0,0,Math.max(s.params.blurX,s.params.blurY)+"px",n(s.params.color)].join(" "))}this.DOM.style.textShadow=e.join(",")},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.Shape=function(e,i,s){this.DOM=t("svg",{width:2*e.offsetWidth,height:2*e.offsetHeight,style:{position:"absolute",top:"0px",left:"0px",width:2*e.offsetWidth+"px",height:2*e.offsetWidth+"px",transform:"matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)"}}),this._x=i.x?i.x:0,this._y=i.y?i.y:0,this._alpha=i.alpha?i.alpha:1,this._transform="";var n=function(t,e){if("string"==typeof t)var i=document.createElementNS("http://www.w3.org/2000/svg",t);else var i=t;if(e)for(var s in e)i.setAttribute(s,e[s]);return i},o=n("defs"),r=n("g",{}),a=n("g",{transform:"translate("+this._x+","+this._y+")",opacity:this._alpha});a.appendChild(r);var h=a;this.DOM.appendChild(o),this.DOM.appendChild(h),this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(t){return"hidden"!==this.DOM.style.visibility}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineSetter__("alpha",function(t){this.setAlpha(t)}),this.__defineGetter__("x",function(t){return this._x}),this.__defineGetter__("y",function(t){return this._y}),this.__defineGetter__("alpha",function(t){return this._alpha}),this.__defineGetter__("transform",function(t){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode){var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]];this._transform="matrix("+e.join(",")+")"}else this._transform="matrix3d("+t.matrix.join(",")+")";"2d"===t.mode?(this.DOM.style.transform="matrix(1,0,0,1,0,0)",n(r,{transform:this._transform})):(this.DOM.style.transformOrigin=this._x+f+"px "+(this._y+u)+"px 0",this.DOM.style.transform=this._transform)}),this.line={width:0,color:"#ffffff",alpha:1},this.fill={fill:"none",alpha:1,fillRule:"nonzero"};var l=function(t){for(var e=parseInt(t).toString(16);e.length<6;)e="0"+e;return"#"+e},d=function(t,e){n(t,{stroke:e.line.color,"stroke-width":e.line.width,"stroke-opacity":e.line.alpha}),e.line.caps&&t.setAttribute("stroke-linecap",e.line.caps),e.line.joints&&t.setAttribute("stroke-linejoin",e.line.joints),e.line.miterLimit&&t.setAttribute("stroke-miterlimit",e.line.miterLimit)},c=function(t,e){n(t,{fill:e.fill.fill,"fill-opacity":e.fill.alpha,"fill-rule":e.fill.fillRule})},p={lastPath:null,scheduleClear:[]},f=0,u=0;this.offset=function(t,e){f=t,u=e,n(a,{transform:"translate("+(this._x+f)+","+(this._y+u)+")"})},this.setX=function(t){t&&(this._x=t,n(a,{transform:"translate("+(this._x+f)+","+(this._y+u)+")"}))},this.setY=function(t){t&&(this._y=t,n(a,{transform:"translate("+(this._x+f)+","+(this._y+u)+")"}))},this.setAlpha=function(t){t&&(this._alpha=t,n(a,{opacity:this._alpha}))},this.moveTo=function(t){var e=n("path",{d:"M"+t.join(" ")});c(e,this),p.lastPath=e,d(e,this),r.appendChild(p.lastPath)},this.lineTo=function(t){p.lastPath||(p.lastPath=n("path",{d:"M0 0"}),c(p.lastPath,this),d(p.lastPath,this),r.appendChild(p.lastPath)),n(p.lastPath,{d:p.lastPath.getAttribute("d")+" L"+t.join(" ")})},this.curveTo=function(t){p.lastPath||(p.lastPath=n("path",{d:"M0 0"}),c(p.lastPath,this),d(p.lastPath,this),r.appendChild(p.lastPath)),n(p.lastPath,{d:p.lastPath.getAttribute("d")+" Q"+t.join(" ")})},this.lineStyle=function(t){t.length<3||(this.line.width=t[0],this.line.color=l(t[1]),this.line.alpha=t[2],t[3]&&(this.line.caps=t[3]),t[4]&&(this.line.joints=t[4]),t[5]&&(this.line.miterLimit=t[5]),p.lastPath&&d(p.lastPath,this))},this.drawPath=function(t){var e=t[0],i=t[1];this.fill.fillRule="nonZero"===t[2]?"nonzero":"evenodd";for(var s="M0 0",o=0;o<e.length;o++)switch(e[o]){default:case 0:continue;case 1:s+=" M"+i.splice(0,2).join(" ");break;case 2:s+=" L"+i.splice(0,2).join(" ");break;case 3:s+=" Q"+i.splice(0,4).join(" ");break;case 4:i.splice(0,2),s+=" M"+i.splice(0,2).join(" ");break;case 5:i.splice(0,2),s+=" L"+i.splice(0,2).join(" ");break;case 6:s+=" C"+i.splice(0,6).join(" ")}var a=n("path",{d:s});c(a,this),d(a,this),r.appendChild(a),this._clear()},this.beginFill=function(t){0!==t.length&&(this.fill.fill=l(t[0]),t.length>1&&(this.fill.alpha=t[1]))},this.endFill=function(t){this.fill.fill="none"},this.drawRect=function(t){p.drawing&&console.log(p.drawing),t[2]<0&&(t[0]+=t[2],t[2]=-t[2]),t[3]<0&&(t[1]+=t[3],t[3]=-t[3]);var e=n("rect",{x:t[0],y:t[1],width:t[2],height:t[3]});c(e,this),d(e,this),r.appendChild(e)},this.drawRoundRect=function(t){var e=n("rect",{x:t[0],y:t[1],width:t[2],height:t[3],rx:t[4],ry:t[5]});c(e,this),d(e,this),this.DOM.appendChild(e)},this.drawCircle=function(t){var e=n("circle",{cx:t[0],cy:t[1],r:t[2]});c(e,this),d(e,this),r.appendChild(e)},this.drawEllipse=function(t){var e=n("ellipse",{cx:t[0],cy:t[1],rx:t[2],ry:t[3]});c(e,this),d(e,this),r.appendChild(e)},this.drawTriangles=function(t){if(t[1].length%3!==0)throw new Error("Illegal drawTriangles index argument. Indices array size must be a multiple of 3.");for(var e=[],i=[],s=0;s<t[1].length/3;s++){var n=t[1][3*s],o=t[1][3*s+1],r=t[1][3*s+2],a=t[0][2*n],h=t[0][2*n+1],l=t[0][2*o],d=t[0][2*o+1],c=t[0][2*r],p=t[0][2*r+1];e.push(1,2,2,2),i.push(a,h,l,d,c,p,a,h)}this.drawPath([e,i,"evenOdd"])},this._clear=function(){if(!(p.scheduleClear.length<1)){for(p.scheduleTimer>-1&&(clearTimeout(p.scheduleTimer),p.scheduleTimer=-1);r.lastChild&&p.scheduleClear.length>0;)r.removeChild(p.scheduleClear.pop());p.scheduleClear=[]}},this.clear=function(){for(var t=r.children?r.children:r.childNodes,e=0;e<t.length;e++)p.scheduleClear.push(t[e]);var i=this;p.scheduleTimer=setTimeout(function(){i._clear(),p.scheduleTimer=-1},60)},this.__defineGetter__("filters",function(t){return[]}),this.__defineSetter__("filters",function(t){this.setFilters([t])}),this.setFilters=function(t){var e=t[0];this.DOM.removeChild(o),o=n("defs");for(var i=0;i<e.length;i++){var s=e[i],r=n("filter",{id:"fe"+s.type+i,x:"-100%",y:"-100%",width:"400%",height:"400%"});switch(s.type){default:break;case"blur":r.appendChild(n("feGaussianBlur",{in:"SourceGraphic",stdDeviation:s.params.blurX+" "+s.params.blurY}));break;case"glow":var l=Math.floor(s.params.color/65536),d=Math.floor(s.params.color%65536/256),c=s.params.color%256,p=[0,0,0,l/256,0,0,0,0,d/256,0,0,0,0,c/256,0,0,0,0,1,0];r.appendChild(n("feColorMatrix",{type:"matrix",values:p.join(" ")})),r.appendChild(n("feGaussianBlur",{stdDeviation:s.params.blurX+" "+s.params.blurY,result:"coloredBlur"}));var f=n("feMerge");f.appendChild(n("feMergeNode",{in:"coloredBlur"})),f.appendChild(n("feMergeNode",{in:"SourceGraphic"})),r.appendChild(f)}o.appendChild(r)}this.DOM.appendChild(o),this.DOM.removeChild(h);for(var u=a,i=0;i<e.length;i++){var m=n("g",{filter:"url(#fe"+e[i].type+i+")"});m.appendChild(u),u=m}this.DOM.appendChild(u),h=u},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.Sprite=function(e,i,s){this.DOM=t("div",{style:{position:"absolute",top:i.y?i.y+"px":"0px",left:i.x?i.x+"px":"0px",width:"100%",height:"100%",overflow:"visible",transformOrigin:"0 0 0"}}),i.scaleX=1,i.scaleY=1,i.children=[],this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(t){return"hidden"!==this.DOM.style.visibility}),this.__defineSetter__("alpha",function(t){this.DOM.style.opacity=t}),this.__defineGetter__("alpha",function(t){return this.DOM.style.opacity}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(t){return this.DOM.offsetLeft}),this.__defineGetter__("y",function(t){return this.DOM.offsetTop}),this.__defineGetter__("transform",function(t){return{}}),this.__defineSetter__("transform",function(t){if("2d"===t.mode)var e=[t.matrix[0],t.matrix[3],t.matrix[1],t.matrix[4],t.matrix[2],t.matrix[5]],i="matrix("+e.join(",")+")";else var i="matrix3d("+t.matrix.join(",")+")";this.DOM.style.transform=i}),this.setX=function(t){this.DOM.style.left=t+"px"},this.setY=function(t){this.DOM.style.top=t+"px"},this.setWidth=function(t){this.DOM.style.width=t+"px"},this.setHeight=function(t){this.DOM.style.height=t+"px"},this.addChild=function(t){var n=s.getObject(t);if(i.children.push(n),n)if(n.DOM){if("Shape"===n.getClass()){var o=this.x+e.offsetWidth/2,r=this.y+e.offsetHeight/2;n.offset(o,r),n.DOM.style.left=-o+"px",n.DOM.style.top=-r+"px"}this.DOM.appendChild(n.DOM)}else s.invokeError("Sprite.addChild failed. Attempted to add non object","err")},this.removeChild=function(t){var e=s.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){s.invokeError(t.stack,"err")}},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)},e.prototype.Unpack.SpriteRoot=function(t,e,i){this.DOM=t,this.addChild=function(t){var e=i.getObject(t);e&&(e.DOM?("Shape"===e.getClass()&&(e.DOM.style.left=-this.x+"px",e.DOM.style.top=-this.y+"px",e.setX(this.x),e.setY(this.y)),this.DOM.appendChild(e.DOM)):i.invokeError("Sprite.addChild failed. Attempted to add non object","err"))},this.removeChild=function(t){var e=i.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){i.invokeError(t.stack,"err")}}},e.prototype.Unpack.Button=function(e,i,s){this.DOM=t("div",{className:"button",style:{position:"absolute",top:i.y?i.y+"px":"0px",left:i.x?i.x+"px":"0px"}},[t("text",i.text)]),i.scaleX=1,i.scaleY=1,this.__defineSetter__("visible",function(t){this.DOM.style.visibility=t?"visible":"hidden"}),this.__defineGetter__("visible",function(t){return"hidden"!==this.DOM.style.visibility}),this.__defineGetter__("transform",function(t){return{}}),this.__defineSetter__("transform",function(t){}),this.__defineSetter__("filters",function(t){}),this.__defineGetter__("filters",function(t){return[]}),this.__defineSetter__("alpha",function(t){i.alpha=Math.min(Math.max(t,0),1),this.DOM.style.opacity=i.alpha+""}),this.__defineGetter__("alpha",function(t){return void 0!==i.alpha?i.alpha:1}),this.__defineSetter__("scaleX",function(t){if(!(t>50)){i.scaleX=t;for(var e=0;e<this.DOM.children.length;e++)this.DOM.children[e].style.transform="scale("+i.scaleX+","+i.scaleY+")"}}),this.__defineSetter__("scaleY",function(t){if(!(t>50)){i.scaleY=t;for(var e=0;e<this.DOM.children.length;e++)this.DOM.children[e].style.transform="scale("+i.scaleX+","+i.scaleY+")"}}),this.__defineGetter__("scaleX",function(t){return i.scaleX}),this.__defineGetter__("scaleY",function(t){return i.scaleY}),this.__defineSetter__("x",function(t){this.setX(t)}),this.__defineSetter__("y",function(t){this.setY(t)}),this.__defineGetter__("x",function(t){return this.DOM.offsetLeft}),this.__defineGetter__("y",function(t){return this.DOM.offsetTop}),this.setX=function(t){this.DOM.style.left=t+"px"},this.setY=function(t){this.DOM.style.top=t+"px"},this.setWidth=function(t){this.DOM.style.width=t+"px"},this.setHeight=function(t){this.DOM.style.height=t+"px"},this.addChild=function(t){var e=s.getObject(t);e&&(e.DOM?("Shape"===e.getClass()&&(e.DOM.style.left=-this.x+"px",e.DOM.style.top=-this.y+"px",e.setX(this.x),e.setY(this.y)),this.DOM.appendChild(e.DOM)):s.invokeError("Sprite.addChild failed. Attempted to add non object","err"))},this.removeChild=function(t){var e=s.getObject(t);if(e)try{this.DOM.removeChild(e.DOM)}catch(t){s.invokeError(t.stack,"err")}},this.unload=function(){try{e.removeChild(this.DOM)}catch(t){}},e.appendChild(this.DOM)};for(var i in e.prototype.Unpack)e.prototype.Unpack[i].prototype.getClass=function(){var t=i;return function(){return t}}()}();var BinArray=function(){var t={};return t.bsearch=function(t,e,i){if(0===t.length)return 0;if(i(e,t[0])<0)return 0;if(i(e,t[t.length-1])>=0)return t.length;for(var s=0,n=0,o=0,r=t.length-1;s<=r;){if(n=Math.floor((r+s+1)/2),o++,i(e,t[n-1])>=0&&i(e,t[n])<0)return n;i(e,t[n-1])<0?r=n-1:i(e,t[n])>=0?s=n:console.error("Program Error"),o>1500&&console.error("Too many run cycles.")}return-1},t.binsert=function(e,i,s){var n=t.bsearch(e,i,s);return e.splice(n,0,i),n},t}(),__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},CommentSpaceAllocator=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this._pools=[[]],this.avoid=1,this._width=t,this._height=e,this.length=0}return t.prototype.willCollide=function(t,e){return t.stime+t.ttl>=e.stime+e.ttl/2},t.prototype.pathCheck=function(t,e,i){for(var s=t+e.height,n=e.right,o=0;o<i.length;o++)if(!(i[o].y>s||i[o].bottom<t)){if(!(i[o].right<e.x||i[o].x>n))return!1;if(this.willCollide(i[o],e))return!1}return!0},t.prototype.assign=function(t,e){for(;this._pools.length<=e;)this._pools.push([]);var i=this._pools[e];if(0===i.length)return t.cindex=e,0;if(this.pathCheck(0,t,i))return t.cindex=e,0;for(var s=0,n=0;n<i.length&&(s=i[n].bottom+this.avoid,!(s+t.height>this._height));n++)if(this.pathCheck(s,t,i))return t.cindex=e,s;return this.assign(t,e+1)},t.prototype.add=function(t){this.length++,t.height>this._height?(t.cindex=-2,t.y=0):(t.y=this.assign(t,0),BinArray.binsert(this._pools[t.cindex],t,function(t,e){return t.bottom<e.bottom?-1:t.bottom>e.bottom?1:0}))},t.prototype.remove=function(t){if(!(t.cindex<0)){if(t.cindex>=this._pools.length)throw console.log(t.cindex,t),new Error("cindex out of bounds");var e=this._pools[t.cindex].indexOf(t);e<0||(this._pools[t.cindex].splice(e,1),this.length--)}},t.prototype.setBounds=function(t,e){this._width=t,this._height=e},t}(),AnchorCommentSpaceAllocator=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.add=function(e){t.prototype.add.call(this,e),e.x=(this._width-e.width)/2},e.prototype.willCollide=function(t,e){return!0},e.prototype.pathCheck=function(t,e,i){for(var s=t+e.height,n=0;n<i.length;n++)if(!(i[n].y>s||i[n].bottom<t))return!1;return!0},e}(CommentSpaceAllocator),CoreComment=function(){function t(e,i){if(void 0===i&&(i={}),this.mode=1,this.stime=0,this.text="",this.ttl=4e3,this.dur=4e3,this.cindex=-1,this.motion=[],this.movable=!0,this._alphaMotion=null,this.absolute=!0,this.align=0,this._alpha=1,this._size=25,this._color=16777215,this._border=!1,this._shadow=!0,this._font="",!e)throw new Error("Comment not bound to comment manager.");if(this.parent=e,i.hasOwnProperty("stime")&&(this.stime=i.stime),i.hasOwnProperty("mode")?this.mode=i.mode:this.mode=1,i.hasOwnProperty("dur")&&(this.dur=i.dur,this.ttl=this.dur),this.dur*=this.parent.options.global.scale,this.ttl*=this.parent.options.global.scale,4!==this.mode&&5!==this.mode||(this.dur*=.6,this.ttl*=.6),i.hasOwnProperty("text")&&(this.text=i.text),i.hasOwnProperty("filteredText")&&(this.text=i.filteredText),i.hasOwnProperty("motion")){this._motionStart=[],this._motionEnd=[],this.motion=i.motion;for(var s=0,n=0;n<i.motion.length;n++){this._motionStart.push(s);var o=0;for(var r in i.motion[n]){var a=i.motion[n][r];o=Math.max(a.dur,o),null!==a.easing&&void 0!==a.easing||(i.motion[n][r].easing=t.LINEAR)}s+=o,this._motionEnd.push(s)}this._curMotion=0}i.hasOwnProperty("color")&&(this._color=i.color),i.hasOwnProperty("size")&&(this._size=i.size),i.hasOwnProperty("border")&&(this._border=i.border),i.hasOwnProperty("opacity")&&(this._alpha=i.opacity),i.hasOwnProperty("alpha")&&(this._alphaMotion=i.alpha),i.hasOwnProperty("font")&&(this._font=i.font),i.hasOwnProperty("x")&&(this._x=i.x),i.hasOwnProperty("y")&&(this._y=i.y),i.hasOwnProperty("shadow")&&(this._shadow=i.shadow),i.hasOwnProperty("position")&&"relative"===i.position&&(this.absolute=!1,this.mode<7&&console.warn("Using relative position for CSA comment."))}return t.prototype.init=function(t){void 0===t&&(t=null),null!==t?this.dom=t.dom:this.dom=document.createElement("div"),this.dom.className=this.parent.options.global.className,this.parent.options.global.outline&&this.dom.classList.add("outline"),this.parent.options.global.shadow&&this.dom.classList.add("shadow"),this.dom.appendChild(document.createTextNode(this.text)),this.dom.textContent=this.text,this.dom.innerText=this.text,this.size=this._size,16777215!=this._color&&(this.color=this._color),this.shadow=this._shadow,this._border&&(this.border=this._border),""!==this._font&&(this.font=this._font),void 0!==this._x&&(this.x=this._x),void 0!==this._y&&(this.y=this._y),(1!==this._alpha||this.parent.options.global.opacity<1)&&(this.alpha=this._alpha),this.motion.length>0&&this.animate()},Object.defineProperty(t.prototype,"x",{get:function(){return null!==this._x&&void 0!==this._x||(this.align%2===0?this._x=this.dom.offsetLeft:this._x=this.parent.width-this.dom.offsetLeft-this.width),this.absolute?this._x:this._x/this.parent.width},set:function(t){this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return null!==this._y&&void 0!==this._y||(this.align<2?this._y=this.dom.offsetTop:this._y=this.parent.height-this.dom.offsetTop-this.height),this.absolute?this._y:this._y/this.parent.height},set:function(t){this._y=t,this.absolute||(this._y*=this.parent.height),this.align<2?this.dom.style.top=this._y+"px":this.dom.style.bottom=this._y+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"width",{get:function(){return null!==this._width&&void 0!==this._width||(this._width=this.dom.offsetWidth),this._width},set:function(t){this._width=t,this.dom.style.width=this._width+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return null!==this._height&&void 0!==this._height||(this._height=this.dom.offsetHeight),this._height},set:function(t){this._height=t,this.dom.style.height=this._height+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size},set:function(t){this._size=t,this.dom.style.fontSize=this._size+"px"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"color",{get:function(){return this._color},set:function(t){this._color=t;var e=t.toString(16);e=e.length>=6?e:new Array(6-e.length+1).join("0")+e,this.dom.style.color="#"+e,0===this._color&&this.dom.classList.add("rshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(this._alpha,this.parent.options.global.opacity)+""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"border",{get:function(){return this._border},set:function(t){this._border=t,this._border?this.dom.style.border="1px solid #00ffff":this.dom.style.border="none"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shadow",{get:function(){return this._shadow},set:function(t){this._shadow=t,this._shadow||(this.dom.className=this.parent.options.global.className+" noshadow")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"font",{get:function(){return this._font},set:function(t){this._font=t,this._font.length>0?this.dom.style.fontFamily=this._font:this.dom.style.fontFamily=""},enumerable:!0,configurable:!0}),t.prototype.time=function(t){this.ttl-=t,this.ttl<0&&(this.ttl=0),this.movable&&this.update(),this.ttl<=0&&this.finish()},t.prototype.update=function(){this.animate()},t.prototype.invalidate=function(){this._x=null,this._y=null,this._width=null,this._height=null},t.prototype._execMotion=function(t,e){for(var i in t)if(t.hasOwnProperty(i)){var s=t[i];this[i]=s.easing(Math.min(Math.max(e-s.delay,0),s.dur),s.from,s.to-s.from,s.dur)}},t.prototype.animate=function(){if(this._alphaMotion&&(this.alpha=(this.dur-this.ttl)*(this._alphaMotion.to-this._alphaMotion.from)/this.dur+this._alphaMotion.from),0!==this.motion.length){var t=Math.max(this.ttl,0),e=this.dur-t-this._motionStart[this._curMotion];return this._execMotion(this.motion[this._curMotion],e),this.dur-t>this._motionEnd[this._curMotion]?(this._curMotion++,void(this._curMotion>=this.motion.length&&(this._curMotion=this.motion.length-1))):void 0}},t.prototype.stop=function(){},t.prototype.finish=function(){this.parent.finish(this)},t.prototype.toString=function(){return["[",this.stime,"|",this.ttl,"/",this.dur,"]","(",this.mode,")",this.text].join("")},t.LINEAR=function(t,e,i,s){return t*i/s+e},t}(),ScrollComment=function(t){function e(e,i){
t.call(this,e,i),this.dur*=this.parent.options.scroll.scale,this.ttl*=this.parent.options.scroll.scale}return __extends(e,t),Object.defineProperty(e.prototype,"alpha",{set:function(t){this._alpha=t,this.dom.style.opacity=Math.min(Math.min(this._alpha,this.parent.options.global.opacity),this.parent.options.scroll.opacity)+""},enumerable:!0,configurable:!0}),e.prototype.init=function(e){void 0===e&&(e=null),t.prototype.init.call(this,e),this.x=this.parent.width,this.parent.options.scroll.opacity<1&&(this.alpha=this._alpha),this.absolute=!0},e.prototype.update=function(){this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width},e}(CoreComment),CSSCompatLayer=function(){function t(){}return t.transform=function(t,e){t.style.transform=e,t.style.webkitTransform=e,t.style.msTransform=e,t.style.oTransform=e},t}(),CSSScrollComment=function(t){function e(){t.apply(this,arguments),this._dirtyCSS=!0}return __extends(e,t),Object.defineProperty(e.prototype,"x",{get:function(){return this.ttl/this.dur*(this.parent.width+this.width)-this.width},set:function(t){if("number"==typeof this._x){var e=t-this._x;this._x=t,CSSCompatLayer.transform(this.dom,"translateX("+e+"px)")}else this._x=t,this.absolute||(this._x*=this.parent.width),this.align%2===0?this.dom.style.left=this._x+"px":this.dom.style.right=this._x+"px"},enumerable:!0,configurable:!0}),e.prototype.update=function(){this._dirtyCSS&&(this.dom.style.transition="transform "+this.ttl+"ms linear",this.x=-this.width,this._dirtyCSS=!1)},e.prototype.invalidate=function(){t.prototype.invalidate.call(this),this._dirtyCSS=!0},e.prototype.stop=function(){this.dom.style.transition="",this.x=this._x,this._x=null,this.x=this.ttl/this.dur*(this.parent.width+this.width)-this.width,this._dirtyCSS=!0},e}(ScrollComment),CommentManager=function(){function t(t){var e=0,s=this;this._listeners={},this._lastPosition=0,this.stage=t,this.paused=!0,this.pausedTime=0,this.canvas=document.createElement("canvas"),this.canvasFPS=0,s.canvas.style.width="100%",s.canvas.style.height="100%",s.stage.appendChild(s.canvas),this.options={global:{opacity:1,scale:1,className:"cmt",useCSS:!1,autoOpacity:!1,autoOpacityVal:1,density:0,outline:!1,shadow:!0},scroll:{opacity:1,scale:1},limit:0},this.timeline=[],this.runline=[],this.position=0,this.limiter=0,this.filter=null,this.csa={scroll:new CommentSpaceAllocator(0,0),top:new AnchorCommentSpaceAllocator(0,0),bottom:new AnchorCommentSpaceAllocator(0,0),reverse:new CommentSpaceAllocator(0,0),scrollbtm:new CommentSpaceAllocator(0,0)},this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight;var n=0;this.startTimer=function(){if(!(e>0)){var t=(new Date).getTime(),i=this;e=window.setInterval(function(){var e=(new Date).getTime()-t;t=(new Date).getTime(),i.onTimerEvent(e,i),i.sendQueueLoader()},1e3/60),this.paused=!1,this.pausedTime=Date.now()-n}},this.stopTimer=function(){window.clearInterval(e),e=0,this.paused=!0,n=Date.now()};var o=(this.options.global.opacity,!1),r=0,a=0,d=function(){s.options.global.autoOpacity&&(s.options.global.useCSS?s.stage.style.opacity=i(a):s.options.global.autoOpacityVal=s.options.global.opacity*i(a))};setInterval(function(){s.canvasFPS=r,r=0},1e3),this.addEventListener("enterComment",function(){a++,d()}),this.addEventListener("exitComment",function(){a--,d()}),this.canvasDrawerWrapper=function(t){o||(t||(t=performance.now()),o=!0,r++,s.canvasDrawer(0|t),o=!1)},this.ttlRecalcAll=function(){this.runline.forEach(h)};var c=[];this.send=function(t){c.push(t)},this.sendQueueLoader=function(){performance.now();c.length&&s.sendAsync(c.shift())},this.addEventListener("clear",function(){c=[]}),requestAnimationFrame(this.canvasDrawerWrapper),function(){var t=window.devicePixelRatio;window.addEventListener("resize",function(){var e=window.devicePixelRatio;t!=e&&(s.runline.forEach(function(t){t.textData&&l(t,s.options.global.outline,s.options.global.shadow)}),t=e),s.ttlRecalcAll()})}()}var e=function(t,e){for(var i=Math.PI/180,s=t*i,n=e*i,o=Math.cos,r=Math.sin,a=[o(s)*o(n),o(s)*r(n),r(s),0,-r(n),o(n),0,0,-r(s)*o(n),-r(s)*r(n),o(s),0,0,0,0,1],h=0;h<a.length;h++)Math.abs(a[h])<1e-6&&(a[h]=0);return"matrix3d("+a.join(",")+")"},i=function(t){return-Math.tanh((t-50)/25)/Math.PI*.8+.718},s="-apple-system,Arial,'PingFang SC','STHeiti Light','Hiragino Kaku Gothic ProN','Microsoft YaHei'";t.prototype.stop=function(){this.stopTimer();for(var t=0;t<this.runline.length;t++)"undefined"!=typeof this.runline[t].stop&&this.runline[t].stop()},t.prototype.start=function(){this.startTimer()},t.prototype.seek=function(t){this.position=BinArray.bsearch(this.timeline,t,function(t,e){return t<e.stime?-1:t>e.stime?1:0})},t.prototype.validate=function(t){return null!=t&&this.filter.doValidate(t)},t.prototype.load=function(t){this.timeline=t,this.timeline.sort(function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0}),this.dispatchEvent("load")},t.prototype.insert=function(t){var e=BinArray.binsert(this.timeline,t,function(t,e){return t.stime>e.stime?2:t.stime<e.stime?-2:t.date>e.date?1:t.date<e.date?-1:null!=t.dbid&&null!=e.dbid?t.dbid>e.dbid?1:t.dbid<e.dbid?-1:0:0});e<=this.position&&this.position++,this.dispatchEvent("insert")},t.prototype.clear=function(){for(;this.runline.length>0;)this.runline[0].finish();this.dispatchEvent("clear"),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.setBounds=function(){this.width=this.stage.offsetWidth,this.height=this.stage.offsetHeight,this.dispatchEvent("resize");for(var t in this.csa)this.csa[t].setBounds(this.width,this.height);this.stage.style.perspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.stage.style.webkitPerspective=this.width*Math.tan(40*Math.PI/180)/2+"px",this.canvasResize()},t.prototype.init=function(){this.setBounds(),null==this.filter&&(this.filter=new CommentFilter)},t.prototype.time=function(t){if(t-=1,this.position>=this.timeline.length||Math.abs(this._lastPosition-t)>=2e3){if(this.seek(t),this._lastPosition=t,this.timeline.length<=this.position)return}else this._lastPosition=t;for(;this.position<this.timeline.length&&this.timeline[this.position].stime<=t;this.position++)this.options.limit>0&&this.runline.length>this.limiter||this.validate(this.timeline[this.position])&&this.send(this.timeline[this.position])},t.prototype.canvasResize=function(){try{var t=(this.width,this.height,window.devicePixelRatio);this.canvas.width=this.canvas.offsetWidth*t,this.canvas.height=this.canvas.offsetHeight*t,this.ttlRecalcAll(),n=!0}catch(t){return console.error("shit happened! forcing CSS! ",t.message),void this.useCSS(!0)}};var n=!1;t.prototype.canvasDrawer=function(){if(!this.options.global.useCSS){if(this.paused&&!n)return void requestAnimationFrame(this.canvasDrawerWrapper);var t,e,i=0|performance.now(),s=window.devicePixelRatio,o=this.pausedTime,a=this.canvas.getContext("2d"),h=this.width,l=this.height;a.clearRect(0,0,h*s,l*s),a.globalAlpha=this.options.global.autoOpacity?this.options.global.autoOpacityVal:this.options.global.opacity,a.imageSmoothingEnabled=!1,0!=o&&(this.runline.forEach(function(t){if(t.textData)switch(t.mode){case 1:case 6:t.prev+=o;break;case 4:case 5:t.removeTime+=o}}),this.pausedTime=0);var s=window.devicePixelRatio,d=this;a.globalAlpha=d.options.global.autoOpacity?d.options.global.autoOpacityVal:d.options.global.opacity,d.runline.forEach(function(o){if(o.textData){switch(o.mode){case 1:case 6:n||(o.rx+=o.speed*(i-o.prev)/1e3,o.prev=i,o.x=h-o.rx),t=6==o.mode?o.rx-o.textData.width:h-o.rx,e=o.y;break;case 4:o.x=(h-o.width)/2,t=o.x,e=l-o.y-o.height;break;case 5:o.x=(h-o.width)/2,t=o.x,e=o.y;break;default:return}a.drawImage(o.textData,r(t*s),r(e*s))}}),n=!1,requestAnimationFrame(this.canvasDrawerWrapper)}};var o=Math.ceil,r=Math.round,a=function(t){for(var t=t.toString(16);t.length<6;)t="0"+t;return t},h=function(t){if(t.speed){var e=t.dur-t.ttl;t.dur=(t.parent.width+t.width)/t.speed*1e3,t.ttl=t.dur-e}},l=function(t,e,i){var n=document.createElement("canvas"),h=n.getContext("2d"),l=window.devicePixelRatio;n.width=1,n.height=1,h.font="bold "+t.size*l+"px "+s,h.imageSmoothingEnabled=!1,t.width=o(h.measureText(t.text).width/l)+2,t.height=o(t.size+3)+2,t.oriWidth=o(t.width*l),t.oriHeight=o(t.height*l),n.width=t.oriWidth,n.height=t.oriHeight,h.font="bold "+t.size*l+"px "+s,h.lineWidth=.7*l,h.strokeStyle=0==t._color?"#FFFFFF":"#000000",h.textBaseline="bottom",h.textAlign="left",i&&(h.lineWidth=.25*l,h.shadowBlur=2*l,h.shadowColor=0==t._color?"#FFFFFF":"#000000"),h.fillStyle="#"+a(t.color),h.fillText(t.text,1,n.height-1),e&&h.strokeText(t.text,1,n.height-1),t.border&&(h.lineWidth=r(2*l),h.strokeStyle="#00ffff",h.shadowBlur=0,h.strokeRect(0,0,n.width,n.height)),t.textData=n};return t.prototype.getCommentFromPoint=function(t,e){var i,s,n=[],o=this.height;return this.runline.forEach(function(r){i=t-r.x,s=4==r.mode?e-(o-r.y-r.height):e-r.y,i>=0&&i<=r.width&&s>=0&&s<=r.height&&n.push(r)}),n},t.prototype.useCSS=function(t){this.options.global.useCSS=t,this.clear(),t||(this.stage.style.opacity="",requestAnimationFrame(this.canvasDrawerWrapper))},t.prototype.autoOpacity=function(t){this.options.global.autoOpacity=t},t.prototype.sendAsync=function(t){if(8===t.mode)return void(this.scripting&&this.scripting.eval(t.code));if(this.options.global.density>0&&1==t.mode&&t.border!==!0&&this.csa.scroll.length>=this.options.global.density)return!1;if(null==this.filter||(t=this.filter.doModify(t),null!=t&&t!==!1)){if(this.options.global.useCSS||[1,4,5,6].indexOf(t.mode)==-1){if(1===t.mode||2===t.mode||6===t.mode)var i=new CSSScrollComment(this,t);else var i=new CoreComment(this,t);switch(i.mode){case 1:i.align=0;break;case 2:i.align=2;break;case 4:i.align=2;break;case 5:i.align=0;break;case 6:i.align=1}switch(i.init(),this.stage.appendChild(i.dom),i.dom.transitionStartTime=(new Date).getTime(),i.mode){default:case 1:this.csa.scroll.add(i);break;case 2:this.csa.scrollbtm.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i);break;case 6:this.csa.reverse.add(i);break;case 17:case 7:0===t.rY&&0===t.rZ||(i.dom.style.transform=e(t.rY,t.rZ),i.dom.style.webkitTransform=e(t.rY,t.rZ),i.dom.style.OTransform=e(t.rY,t.rZ),i.dom.style.MozTransform=e(t.rY,t.rZ),i.dom.style.MSTransform=e(t.rY,t.rZ))}i.y=i.y}else{var s=performance.now(),i=new CoreComment(this,t);switch(i.dom={style:{}},l(i,this.options.global.outline,this.options.global.shadow),1==t.mode||6==t.mode?(i.rx=0,i.x=this.width,i.prev=s,i.speed=(this.width+i.width)/i.dur*1e3):4!=t.mode&&5!=t.mode||(i.removeTime=s+i.dur),i.mode){default:case 1:this.csa.scroll.add(i);break;case 4:this.csa.bottom.add(i);break;case 5:this.csa.top.add(i);break;case 6:this.csa.reverse.add(i)}}i.originalData=t,this.dispatchEvent("enterComment",i),this.runline.push(i)}},t.prototype.finish=function(t){this.dispatchEvent("exitComment",t);try{this.stage.removeChild(t.dom)}catch(t){}var e=this.runline.indexOf(t);switch(e>=0&&this.runline.splice(e,1),t.mode){default:case 1:this.csa.scroll.remove(t);break;case 2:this.csa.scrollbtm.remove(t);break;case 4:this.csa.bottom.remove(t);break;case 5:this.csa.top.remove(t);break;case 6:this.csa.reverse.remove(t);break;case 7:}t.textData&&(t.textData=null)},t.prototype.resumeComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&t.classList.contains("paused")&&(t.style.transitionDuration=t.finalDuration+"ms",t.style.transform=t.finalTransform,t.transitionStartTime=(new Date).getTime(),t.classList.remove("paused"))})},t.prototype.pauseComment=function(){Array.prototype.slice.call(this.stage.children).forEach(function(t){t.classList.contains("cmt")&&!t.classList.contains("paused")&&(t.finalTransform=t.style.transform,t.style.transform=window.getComputedStyle(t).getPropertyValue("transform"),t.finalDuration=parseFloat(t.style.transitionDuration)-(new Date).getTime()+t.transitionStartTime,t.style.transitionDuration="10ms",t.classList.add("paused"))})},t.prototype.addEventListener=function(t,e){"undefined"!=typeof this._listeners[t]?this._listeners[t].push(e):this._listeners[t]=[e]},t.prototype.dispatchEvent=function(t,e){if("undefined"!=typeof this._listeners[t])for(var i=0;i<this._listeners[t].length;i++)try{this._listeners[t][i](e)}catch(t){console.err(t.stack)}},t.prototype.onTimerEvent=function(t,e){for(var i=0;i<e.runline.length;i++){var s=e.runline[i];s.hold||s.time(t)}},t}();