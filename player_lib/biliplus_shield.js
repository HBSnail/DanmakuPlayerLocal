var shield=function(){var e,t=/[\x00-\x2f\x3a-\x40\x5b-\x5e\x60\x7b-\x7f]/g,i=!0,s=!0,r=null,n=0,l=!1,o=function(e){return a.playerUnit.querySelectorAll(e)},d=function(e){return a.playerUnit.querySelector(e)},a=null,c=function(e){return 14==e.length&&"k"==e[3]||(e.length>8&&"D"==e[0]||"0"==e)},u={init:function(t){if(i){void 0!=t&&(a=t),i=!1,u.tab(0),void 0==localStorage.shieldList&&(localStorage.shieldList='{"text":[],"user":[],"color":[],"useReg":false,"limit":10,"mode":[],"visitor":false}'),r=JSON.parse(localStorage.shieldList),void 0==r.color&&(r.color=[]),void 0==r.useReg&&(r.useReg=!1),void 0==r.limit&&(r.limit=10),void 0==r.mode&&(r.mode=[]),void 0==r.visitor&&(r.visitor=!1),l=r.useReg,e=r.limit,u.render(),d(".shield-enrty").addEventListener("click",u.show),d(".shield_top .close").addEventListener("click",u.show),d(".shield_item .add").addEventListener("click",u.add);var s,c,f;for(f=o(".shield_tab"),s=0,c=f.length;s<c;s++)f[s].tabNum=s,f[s].addEventListener("mouseenter",function(){u.tab(this.tabNum)}),f[s].addEventListener("mouseleave",function(e){var t=this.getBoundingClientRect(),i=e.clientX,s=e.clientY;(i-t.left<0||i-t.left>t.width||s-t.top<0||s-t.top>t.height)&&u.tab(n)}),f[s].addEventListener("click",function(){u.switchTab(this.tabNum)});d("#useReg").addEventListener("click",function(){l=!l,u.save(),u.render(3)}),d("#blockTop").addEventListener("click",function(){u.mode(5)}),d("#blockBottom").addEventListener("click",function(){u.mode(4)}),d("#blockVisitor").addEventListener("click",function(){u.visitor()});var h=!1,v=function(t){if(h){var i=d("#repeat").getBoundingClientRect(),s=Math.round((t.clientX-i.left)/i.width*49+2);s<2||s>51||(e=s,51==e&&(e=0),u.render(3))}};d("#repeat").addEventListener("mousedown",function(e){h=!0,v(e)}),d("#repeat").addEventListener("mouseup",function(){h=!1,u.save()}),d("#repeat").addEventListener("touchend",function(){h=!1,u.save()}),d(".shield").addEventListener("mousemove",v)}},switchTab:function(e){n=e,d(".shield_body_wrapper").style.transform="translateX("+e*-278+"px)",d(".shield_body_wrapper").style.webkitTransform="translateX("+e*-278+"px)"},tab:function(e){var t=d(".shield"),i=t.getBoundingClientRect(),s=d(".shield .shield_tab:nth-of-type("+(e+1)+")>div").getBoundingClientRect(),r=s.left-i.left,n=s.width,l=d(".shield .shield_tab_slash");l.style.left=r+"px",l.style.width=n+"px"},render:function(t){var i=!0,s=0;for(void 0!=t&&(i=!1,s=t);;){switch(s){case 0:var n,a,c,f="";for(n=0,a=r.text.length;n<a;n++)f+='<div class="shield_item"><div class="text">'+r.text[n]+'</div><div class="delete"></div></div>';for(d("#shield_text").innerHTML=f,c=o("#shield_text .shield_item .delete"),n=0,a=c.length;n<a;n++)c[n].onclick=u.del;break;case 1:for(var c,f="",n=0;n<r.user.length;n++)f+='<div class="shield_item"><div class="text">'+r.user[n]+'</div><div class="delete"></div></div>';for(0==n&&(f='<div class="shield_item">'+ABP.Strings.blockUserEmpty+"</div>"),d("#shield_user").innerHTML=f,c=o("#shield_user .shield_item .delete"),n=0,a=c.length;n<a;n++)c[n].onclick=u.delUser;break;case 2:for(var h,c,f="",n=0;n<r.color.length;n++){for(h=r.color[n].toString(16);h.length<6;)h="0"+h;f+='<div class="shield_color"><div class="color" style="background:#'+h+'">'+r.color[n]+'</div><div class="delete"></div></div>'}for(0==n&&(f='<div class="shield_color">'+ABP.Strings.blockColorEmpty+"</div>"),d("#shield_color").innerHTML=f,c=o("#shield_color .shield_color .delete"),n=0,a=c.length;n<a;n++)c[n].onclick=u.delColor;break;case 3:d("#useReg").className="shield_toggle"+(l?" on":""),d("#blockTop").className="shield_toggle"+(r.mode.indexOf(5)!=-1?" on":""),d("#blockBottom").className="shield_toggle"+(r.mode.indexOf(4)!=-1?" on":""),d("#blockVisitor").className="shield_toggle"+(r.visitor?" on":"");var v=(e-2)/49,m=e+" "+ABP.Strings.repeatPcs;0==e&&(v=1,m=ABP.Strings.repeatUnlimited),d("#repeat .fill").style.width=100*v+"%",d("#repeat .button").style.left=100*v+"%",d("#repeat .slide_info").innerHTML=m;break;default:return}s++}},save:function(){r.useReg=l,r.limit=e,localStorage.shieldList=JSON.stringify(r),u.shield()},show:function(){s?o(".shield")[0].setAttribute("class","shield"):o(".shield")[0].setAttribute("class","shield hidden"),s=!s},add:function(){u.addText(d(".shield_item .new").value)&&(d(".shield_item .new").value="")},addText:function(e){if(""==e||r.text.indexOf(e)!=-1)return!1;try{l&&new RegExp(e)}catch(e){return a.createPopup("格式错误，"+e.message,3e3),!1}return r.text.push(e),u.save(),u.render(0),!0},addUser:function(e){return r.user.indexOf(e)==-1&&(r.user.push(e),u.save(),void u.render(1))},addColor:function(e){return e=parseInt(e,16),!isNaN(e)&&r.color.indexOf(e)==-1&&(r.color.push(e),u.save(),void u.render(2))},mode:function(e){var t,i=(t=r.mode.indexOf(e))==-1;i?r.mode.push(e):r.mode.splice(t,1),u.save(),u.render(3)},visitor:function(){r.visitor=!r.visitor,u.save(),u.render(3)},del:function(e){var t,i=e.target.parentNode.firstChild.innerHTML,s=r.text.indexOf(i);return s!=-1&&(t=r.text.splice(0,s),r.text=t.concat(r.text.splice(1)),u.save(),void u.render(0))},delUser:function(e){var t,i=e.target.parentNode.firstChild.innerHTML.split(" ")[0],s=r.user.indexOf(i);return s!=-1&&(t=r.user.splice(0,s),r.user=t.concat(r.user.splice(1)),u.save(),void u.render(1))},delColor:function(e){var t,i=e.target.parentNode.firstChild.innerHTML,s=r.color.indexOf(1*i);return s!=-1&&(t=r.color.splice(0,s),r.color=t.concat(r.color.splice(1)),u.save(),void u.render(2))},filter:function(e){if(delete e.filteredText,e.isRepeat&&e.isFirstRepeat)e.filteredText=e.text+" (x"+e.repeatCount+")";else if(e.isBlocked)return!1;return e.filtered||(e.oriSize=e.size,e.filtered=!0),e.size=e.oriSize*abpinst.commentScale,e},shield:function(){if(null==a)return!1;var i,s,n=a.cmManager.timeline,o=[],d=0,u=[],f=n.length,h=a.cmManager.runline,v={};if(e>0){for(;d<f;d++)try{o.push(n[d].text.replace(t,""))}catch(e){o.push("")}for(d=0;d<f;d++)if(!(n[d].mode>6)){var m=v[o[d]];if(m){var p=m[m.length-1],g=n[d].stime-p[1];g>=1e4?m.push([n[d].stime,n[d].stime,1,d]):(p[1]=n[d].stime,p[2]++)}else v[o[d]]=[[n[d].stime,n[d].stime,1,d]]}}for(i=0;i<r.text.length;i++)u.push(l?new RegExp(r.text[i]):r.text[i]);var x=function(t,i){if(i.pool)return!1;for(var s=0;s<t.length;s++)if(!(i.stime>t[s][1]))return t[s][2]>=e&&t[s];return!1};for(d=0;d<f;d++){s=n[d],s.isBlocked=!1,s.isRepeat=!1;var k;if(s.mode<=6&&v[o[d]]&&(k=x(v[o[d]],s)))s.isBlocked=!0,s.isRepeat=!0,s.isFirstRepeat=!1,k[3]===d&&(s.isFirstRepeat=!0,s.repeatCount=k[2]),s.blockReason="重复弹幕";else if(r.color.indexOf(s.color)!=-1)s.isBlocked=!0,s.blockReason="颜色";else if(r.user.indexOf(s.hash)!=-1)s.isBlocked=!0,s.blockReason="用户";else if(r.mode.indexOf(s.mode)!=-1)s.isBlocked=!0,s.blockReason="位置";else if(r.visitor&&c(s.hash))s.isBlocked=!0,s.blockReason="游客";else for(i=0;i<u.length;i++)try{if(null!=s.text.match(u[i])){s.isBlocked=!0,s.blockReason=u[i];break}}catch(e){}}for(d=h.length-1;d>=0;d--)h[d].originalData.isBlocked&&h[d].finish();a.renderCommentList()}};return u}();window.shield=shield;